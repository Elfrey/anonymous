(()=>{"use strict";let e="",t="module";function n(...t){return`${e}.settings.${t.join(".")}`}function a(...n){return n=n.filter((e=>"string"==typeof e)),`${t}s/${e}/templates/${n.join("/")}`}function o(t){return game.settings.get(e,t)}function i(t){const a=t.name;t.scope=t.scope??"world",t.config=t.config??!1,t.config&&(t.name=n(a,"name"),t.hint=n(a,"hint")),Array.isArray(t.choices)&&(t.choices=t.choices.reduce(((e,t)=>(e[t]=n(a,"choices",t),e)),{})),game.settings.register(e,a,t)}function s(){ui.combat.render()}function c(){return o("names")}function r(e,t){return`${e} ${n=t,n?n[0].toUpperCase()+n.slice(1):""}`;var n}function l(e,t,n,a){const o="string"==typeof t?t:"info",i="object"==typeof t?t:"object"==typeof n?n:void 0,s="boolean"==typeof t?t:"boolean"==typeof n?n:a??!1;ui.notifications.notify(u(e,i),o,{permanent:s})}function f(...e){const[t,n,a]=e;l(t,"warning",n,a)}function u(...t){let[n,a]=t;return n=`${e}.${n}`,a?game.i18n.format(n,a):game.i18n.localize(n)}function m(t){const n=(...e)=>u(`${t}.${e[0]}`,e[1]);return Object.defineProperties(n,{warn:{value:(...e)=>f(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},info:{value:(...e)=>function(...e){const[t,n,a]=e;l(t,"info",n,a)}(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},error:{value:(...e)=>function(...e){const[t,n,a]=e;l(t,"error",n,a)}(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},has:{value:n=>function(t){return game.i18n.has(`${e}.${t}`,!1)}(`${t}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>function(t){return`${e}.${t}`}(`${t}.${n}`),enumerable:!1,configurable:!1},template:{value:(e,{hash:t})=>n(e,t),enumerable:!1,configurable:!1}}),n}class AnonymousNamesMenu extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"anonymous-names-menu",title:u("templates.names.title"),template:a("names.html"),width:400})}getData(e){const t=u("unknown"),n=c(),a=game.system.documentTypes.Actor.map((e=>({type:e,value:(n[e]??"").trim(),placeholder:r(t,e)})));return{...super.getData(e),types:a,i18n:m("templates.names")}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",(()=>this.close()))}async _updateObject(t,n){var a;a=n,game.settings.set(e,"names",a)}}function d(e){return game.modules.get(e)}function g(){return d(e)}function p(t,n,a){return t.setFlag(e,n,a)}function h(e,t){e.token?y(e.token,t):function(e,t=!1){return game.scenes.map((n=>function(e,t,n=!1){return e.tokens.filter((e=>e.actorId===t.id&&(!n||e.actorLink)))}(n,e,t))).flat()}(e,!0).forEach((e=>y(e,t)))}function y(e,t){t?function(e){const t=e.displayName;if(O(t)||!o("token"))return;let n=t;n===CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER?n=CONST.TOKEN_DISPLAY_MODES.HOVER:n===CONST.TOKEN_DISPLAY_MODES.OWNER&&(n=CONST.TOKEN_DISPLAY_MODES.ALWAYS),e.update({displayName:n})}(e):function(e){const t=e.displayName;if(function(e){return!O(e)}(t))return;const n=S(t);e.update({displayName:n})}(e)}function O(e){return e===CONST.TOKEN_DISPLAY_MODES.HOVER||e===CONST.TOKEN_DISPLAY_MODES.ALWAYS}function S(e){return e===CONST.TOKEN_DISPLAY_MODES.HOVER?CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER:e===CONST.TOKEN_DISPLAY_MODES.ALWAYS?CONST.TOKEN_DISPLAY_MODES.OWNER:e}function v(e,t){const n=e.object.actor;if(!n||n.hasPlayerOwner)return;const a=function(e){const t=document.createElement("template"),n=b(e);return t.innerHTML=`<div class="control-icon${n?" active":""}" data-action="anonymous-toggle">\n    <i class="fa-solid fa-signature" title="${u("hud.title")}"></i>\n</div>`,t.content.firstChild}(n);a.addEventListener("click",(()=>k(n))),t.find(".col.right").append(a)}function b(t){return t instanceof Combatant&&t.actor&&(t=t.actor),!!(t instanceof Actor&&t.hasPlayerOwner)||!!function(t,n,a){return t.getFlag(e,"showName")??void 0}(t)}async function k(e){const t=!b(e);e instanceof Actor||!e.actor?await p(e,"showName",t):await p(e.actor,"showName",t),canvas.tokens.hud?.rendered&&canvas.tokens.hud.render();const n=e instanceof Actor?e:e.actor;return n&&h(n,t),t}function E(e){const t=u("unknown"),n=e instanceof Actor?e.type:e.actor?.type;return n?(c()[n]??"").trim()||r(t,n):t}function N(e,t){!function({entries:e,choices:t,defaultData:n={}}){Array.isArray(t)&&(t=t.reduce(((e,t)=>(e[t]={},e)),{}));for(const a in t){const o=t[a],i=o.name??("function"==typeof n.name?n.name(a):n.name)??"";let s=o.icon??("function"==typeof n.icon?n.icon(a):n.icon)??"";if(!$(s).length){const e=$("<i></i>");e.addClass(s),s=e[0].outerHTML}e.unshift({name:i,icon:s,callback:e=>{o.callback?o.callback(e):n.callback&&n.callback(e,a)},condition:e=>o.condition?.(e)??n.condition?.(e,a)??!0})}}({entries:t,defaultData:{name:e=>u(`context.${e}`),icon:"fa-solid fa-signature",callback:e=>{const t=e.attr("data-document-id"),n=game.actors.get(t);n&&k(n)},condition:(e,t)=>{const n=e.attr("data-document-id"),a=game.actors.get(n);return!!a&&!a.hasPlayerOwner&&("show"===t?!b(a):b(a))}},choices:["show","hide"]})}function w(e,t,n,a=!1){let o=e.find("*");a&&(o=o.addBack()),o.contents().each(((e,a)=>{a.nodeType===Node.TEXT_NODE&&a.textContent?.trim()&&$(a).replaceWith(a.textContent.replace(t,n))}))}function A({message:e,$html:t,isAnonymous:n,actor:a}){if(n&&e.rolls.length&&o("criticals")){const e=game.i18n.localize("DND5E.CriticalHit"),n=game.i18n.localize("DND5E.PowerfulCritical"),a=new RegExp(` (\\(([\\w ]*)?(?:${e}|${n})([\\w ]*)?\\))$`,"igm"),o=t.find("header .flavor-text");game.user.isGM&&w(o,a,' <span class="anonymous-replaced">$1</span>',!0),w(o,a,"",!0)}}function T(e){i({name:"pf2e.traits",type:String,default:"never",config:!0,choices:{never:n("pf2e.traits.choices.never"),rolls:n("pf2e.traits.choices.rolls"),always:n("pf2e.traits.choices.always")}})}function C(e){e&&function(){let e="";if(game.settings.settings.has("pf2e.metagame.tokenSetsNameVisibility")?e="metagame.tokenSetsNameVisibility":game.settings.settings.has("pf2e.metagame_tokenSetsNameVisibility")&&(e="metagame_tokenSetsNameVisibility"),!e||!game.settings.get("pf2e",e))return;const t=g().title,n=game.i18n.localize("PF2E.SETTINGS.Metagame.TokenSetsNameVisibility.Name");game.settings.set("pf2e",e,!1),f("pf2e.disabled",{module:t,setting:n},!0)}()}function D({message:e,isAnonymous:t,$html:n}){const a=game.user.isGM,i=e.target?.actor,s=o("criticals"),c=o("rolls");if(i&&!i.hasPlayerOwner&&!b(i)){const e=n.find('.flavor-text .target-dc [data-whose="target"]');if(e.length){const t=e.first();a?t.attr("data-visibility","gm"):t.text(u("pf2e.target",{name:E(i)}))}}if(!a&&t){const t=o("pf2e.traits");if(e.rolls.length)if(c){const e=n.find(".flavor-text hr + .tags");e.length&&(e.prev("hr").remove(),e.remove()),s&&n.find(".message-content .dice-roll .dice-result .dice-total").css("color","var(--color-text-dark-primary)"),"never"!==t&&n.find(".flavor-text .tags").remove()}else"always"===t&&n.find(".flavor-text .tags").first().remove();else"always"===t&&n.find(".message-content section.tags").remove()}if(t&&e.rolls.length&&c&&s){const e=game.i18n.localize("PF2E.Check.Result.Degree.Attack.criticalSuccess"),t=game.i18n.localize("PF2E.Check.Result.Degree.Attack.success"),o=new RegExp(`(\\((${e}|${t})\\))`,"gmi"),i=a?'<span class="anonymous-replaced">$1</span>':"";w(n.find("header .flavor-text"),o,i,!0)}}const M=/\(dc \d+\)/gim;function _({message:e,isAnonymous:t,$html:n}){if(game.user.isGM)return;if(t&&o("rolls")){const e=n.find(".dice-tooltip");e.empty(),e.css("padding-top",0),o("criticals")&&n.find(".dice-total").removeClass("critical fumble");const t=n.find(".phase-saving-throws .phase-heading");t.text(t.text().replace(M,""))}const a=n.find(".phase-attack .token-info .token-name"),i=e.getFlag("wire","activation.attack.targetActorUuid");if(a.length&&i)try{const e=fromUuidSync(i)?.actor;!e||e.hasPlayerOwner||b(e)||a.text(E(e))}catch(e){console.error(e)}const s=n.find(".phase-saving-throws .saving-throw-target:has(.target-name)"),c=e.getFlag("wire","activation.targetUuids");if(s.length&&c?.length)try{for(const e of c){const t=fromUuidSync(e)?.actor;!t||t.hasPlayerOwner||b(t)||s.filter(`[data-actor-id="${e}"]`).find(".target-name").text(E(t))}}catch(e){console.error(e)}}const P=H(),x=H(),L=H();function H(){const e=[],t=function(...t){e.forEach((e=>e(...t)))};return t.add=t=>e.push(t),t}!function(n,a=!1){e||(e="anonymous"),t=a?"system":"module"}(),Hooks.once("init",(()=>{i({name:"version",type:String,default:""}),i({name:"names",type:Object,default:{},onChange:s}),i({name:"token",type:Boolean,default:!0,config:!0}),i({name:"rolls",type:Boolean,default:!0,config:!0}),i({name:"criticals",type:Boolean,default:!0,config:!0}),i({name:"cardContent",type:Boolean,default:!1,config:!0}),i({name:"footer",type:Boolean,default:!1,config:!0}),function(t){const a=t.name;t.name=n("menus",a,"name"),t.label=n("menus",a,"label"),t.hint=n("menus",a,"hint"),t.restricted=t.restricted??!0,t.icon=t.icon??"fas fa-cogs",game.settings.registerMenu(e,a,t)}({name:"namesMenu",type:AnonymousNamesMenu}),g().api={playersSeeName:b,toggleSeeName:k,getName:E};const t=function(){const e=game.data,t=e.users.find((t=>t._id===e.userId));return!!t&&t.role>=CONST.USER_ROLES.GAMEMASTER}();t&&(Hooks.on("getActorDirectoryEntryContext",N),Hooks.on("renderTokenHUD",v)),function(){switch(game.system.id){case"pf2e":P.add(T),x.add(C),L.add(D);break;case"dnd5e":L.add(A)}d("wire")?.active&&L.add(_)}(),P(t)})),Hooks.once("ready",(()=>{x(game.user.isGM)})),Hooks.on("renderCombatTracker",(function(e,t){const n=ui.combat.viewed?.combatants;n&&n.size&&t.find("#combat-tracker .combatant").each((function(){const e=this.dataset.combatantId,t=n.get(e);if(!t||!t.actor||t.actor.hasPlayerOwner)return;const a=b(t);if(game.user.isGM){const e=this.querySelector(".combatant-controls"),n=e.querySelector('.combatant-control[data-control="toggleHidden"]'),o=function(e){const t=document.createElement("template"),n=e?"context.hide":"context.show";return t.innerHTML=`<a\n    class="combatant-control${e?" active":""}"\n    data-control="toggle-name-visibility"\n    data-tooltip="${u(n)}"\n>\n    <i class="fa-solid fa-signature"></i>\n</a>`,t.content.firstChild}(a);o.addEventListener("click",(e=>function(e,t){e.preventDefault(),e.stopPropagation(),e.shiftKey&&t.actor&&t.actor.isToken&&game.combat?.scene?function(e){return e.combat.turns.filter((t=>t.actorId===e.actorId))}(t).forEach(k):k(t)}(e,t))),n?n.after(o):e.appendChild(o)}else a||(this.querySelector("h4").textContent=E(t))}))})),Hooks.on("renderChatMessage",(function(e,t){if(e.blind)return;const n=game.user.isGM,a=e.speaker,i=ChatMessage.getSpeakerActor(a),s=!i||b(i),c=!!i&&!i.hasPlayerOwner;if(i&&!s&&function(e,t,n){const a=e.speaker,o=new Set;if(a.alias&&o.add(a.alias),t.name&&o.add(t.name),a.token&&a.scene){const e=game.scenes.get(a.scene),t=e?.tokens.get(a.token);t?.name&&o.add(t.name)}if(!o.size)return;const i=Array.from(o).map((e=>RegExp.escape(e))).join("|"),s=new RegExp(`(${i})`,"gmi"),c=E(t);w(n,s,game.user.isGM?`<span class="anonymous-replaced" title="${c}">$1</span>`:c)}(e,i,t),!n&&c){if(e.rolls.length&&o("rolls")){const e=t.find(".message-content .dice-roll .dice-result");e.find(".dice-formula, .dice-tooltip").remove(),o("criticals")&&e.find(".dice-total").removeClass("critical fumble")}o("footer")&&t.find(".message-content footer.card-footer").remove(),o("cardContent")&&t.find(".message-content .card-content").remove()}L({message:e,actor:i,$html:t,playersCanSee:s,isAnonymous:c})})),Hooks.on("preCreateToken",(function(e){if(e.actor?.hasPlayerOwner)return;const t=e.displayName,n=S(t);n!==t&&(e._source.displayName=n)})),Hooks.on("updateActor",(function(t,n){let a=void 0!==getProperty(n,`flags.${e}.${["showName"].join("/")}`);"ownership"in n&&(h(t,t.hasPlayerOwner),a=!0),a&&s()}))})();
//# sourceMappingURL=main.js.map